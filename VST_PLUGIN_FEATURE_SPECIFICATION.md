# WindsynthRecorder VST 插件支持功能规格说明

## 概述

为 WindsynthRecorder 添加 VST 插件实时监听和离线处理能力，支持专业母带制作插件（如 Ozone 11）的集成，提供完整的音频后期处理工作流。

## 功能目标

### 核心功能
1. **VST3 插件支持**：加载和管理 VST3 格式插件
2. **实时音频处理**：录音时实时应用插件效果进行监听
3. **离线音频处理**：录音完成后应用插件链进行最终处理
4. **插件链管理**：支持多个插件的串联处理
5. **参数控制**：实时调整插件参数
6. **预设管理**：保存和加载插件配置预设

### 专业功能
1. **母带制作支持**：专门优化 Ozone 11 等母带插件
2. **高质量音频**：支持高采样率（96kHz, 192kHz）和高位深（24bit, 32bit float）
3. **A/B 对比**：处理前后音频对比功能
4. **批量处理**：对多个文件应用相同插件链
5. **性能监控**：CPU 使用率和延迟监控

## 技术架构

### 整体架构
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   SwiftUI UI    │◄──►│  Swift Services  │◄──►│  C++ JUCE Core  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │ AVAudioEngine    │    │   VST3 Plugins  │
                       │ (现有录音系统)    │    │   (Ozone 11等)  │
                       └──────────────────┘    └─────────────────┘
```

### 核心组件

#### 1. JUCE C++ 音频处理核心
- **VSTPluginManager**: 插件扫描、加载、管理
- **AudioProcessingChain**: 插件链管理和音频路由
- **RealtimeProcessor**: 实时音频处理引擎
- **OfflineProcessor**: 离线音频处理引擎

#### 2. Swift 桥接层
- **VSTBridge**: C++ 和 Swift 之间的数据传递
- **VSTPluginService**: Swift 层的插件服务封装
- **AudioChainManager**: 音频链管理服务
- **RealtimeAudioService**: 实时音频服务

#### 3. SwiftUI 用户界面
- **VSTPluginBrowser**: 插件浏览器
- **AudioChainEditor**: 音频链编辑器
- **PluginParameterView**: 插件参数控制界面
- **VSTProcessorView**: VST 处理器主界面

## 文件结构

```
WindsynthRecorder/
├── Libraries/
│   ├── JUCE/                    # JUCE 框架（已存在）
│   ├── VSTSupport/              # VST 支持库（新增）
│   │   ├── VSTPluginManager.hpp
│   │   ├── VSTPluginManager.cpp
│   │   ├── AudioProcessingChain.hpp
│   │   ├── AudioProcessingChain.cpp
│   │   ├── RealtimeProcessor.hpp
│   │   ├── RealtimeProcessor.cpp
│   │   ├── OfflineProcessor.hpp
│   │   └── OfflineProcessor.cpp
│   └── Bridge/                  # Swift-C++ 桥接（新增）
│       ├── VSTBridge.h
│       ├── VSTBridge.mm
│       └── VSTBridge.swift
├── Services/                    # 现有服务目录
│   ├── VSTPluginService.swift   # VST 插件服务（新增）
│   ├── AudioChainManager.swift  # 音频链管理（新增）
│   ├── RealtimeAudioService.swift # 实时音频服务（新增）
│   ├── AudioRecorder.swift      # 现有录音服务（需修改）
│   └── AudioProcessor.swift     # 现有音频处理（需修改）
└── Views/                       # 现有视图目录
    ├── VSTPluginBrowser.swift   # 插件浏览器（新增）
    ├── AudioChainEditor.swift   # 音频链编辑器（新增）
    ├── PluginParameterView.swift # 插件参数控制（新增）
    ├── VSTProcessorView.swift   # VST 处理器主界面（新增）
    ├── ContentView.swift        # 主界面（需修改）
    └── AudioProcessorView.swift # 音频处理界面（需修改）
```

## 数据流设计

### 实时处理流程
```
麦克风输入 → AVAudioEngine → VST实时处理链 → 监听输出
                            ↓
                         原始录音文件保存
```

### 离线处理流程
```
原始录音文件 → VST离线处理链 → 处理后文件 → FFmpeg最终编码 → 输出文件
```

### 混合工作流
```
录音文件 → VST插件处理 → 中间文件 → FFmpeg处理 → 最终输出
         (EQ, 压缩, 母带)      (格式转换, 编码)
```

## 用户界面设计

### 主要界面组件

1. **VST 插件浏览器**
   - 插件列表和分类
   - 插件搜索和过滤
   - 插件信息显示
   - 插件添加到处理链

2. **音频处理链编辑器**
   - 可视化插件链
   - 拖拽排序插件
   - 插件旁路开关
   - 链路音频监控

3. **插件参数控制面板**
   - 实时参数调节
   - 参数自动化
   - 预设加载保存
   - A/B 对比功能

4. **处理进度和监控**
   - 实时 CPU 使用率
   - 音频延迟显示
   - 处理进度条
   - 错误状态提示

### 界面集成点

1. **主录音界面**：添加"启用 VST 处理"选项
2. **音频处理界面**：集成 VST 插件选项
3. **设置界面**：添加 VST 插件路径配置
4. **批量处理界面**：支持 VST 插件链应用

## 性能要求

### 实时处理性能
- **延迟要求**：< 10ms（在 44.1kHz 采样率下）
- **CPU 使用率**：< 50%（单个插件）
- **内存使用**：< 500MB（包含多个插件实例）
- **音频质量**：支持 24bit/96kHz 无损处理

### 离线处理性能
- **处理速度**：> 10x 实时速度
- **并发处理**：支持多线程加速
- **大文件支持**：> 2GB 音频文件
- **批量处理**：> 100 个文件

## 兼容性要求

### 插件格式支持
- **VST3**：主要支持格式
- **AU**：macOS 原生格式（可选）
- **插件架构**：Intel x64, Apple Silicon (ARM64)

### 系统要求
- **macOS**：10.15+ (Catalina 及以上)
- **内存**：最低 8GB，推荐 16GB+
- **存储**：SSD 推荐（提高加载速度）
- **音频接口**：支持 Core Audio 的音频设备

### 插件兼容性
- **Ozone 11**：重点测试和优化
- **FabFilter Pro-Q 3**：EQ 插件测试
- **Waves**：常用插件包测试
- **Native Instruments**：合成器和效果器测试

## 开发里程碑

### 第一阶段：基础设施（第1-2周）
- [ ] JUCE 框架集成到 Xcode 项目
- [ ] C++/Swift 桥接层建立
- [ ] 基础插件扫描功能
- [ ] 简单插件加载测试

### 第二阶段：核心功能（第3-4周）
- [ ] VST 插件管理器完成
- [ ] 基础音频处理链
- [ ] 简单实时音频处理
- [ ] 插件参数读取和设置

### 第三阶段：实时处理（第5-6周）
- [ ] 与 AVAudioEngine 集成
- [ ] 实时插件链处理
- [ ] 低延迟优化
- [ ] 基础用户界面

### 第四阶段：离线处理（第7-8周）
- [ ] 离线音频处理引擎
- [ ] 批量处理功能
- [ ] 进度监控和取消
- [ ] 与现有 FFmpeg 流程整合

### 第五阶段：高级功能（第9-10周）
- [ ] 插件预设管理
- [ ] 高级用户界面
- [ ] 性能优化
- [ ] 错误处理完善

### 第六阶段：测试和发布（第11-12周）
- [ ] 全面测试（包括 Ozone 11）
- [ ] 用户文档编写
- [ ] 性能基准测试
- [ ] 发布准备

## 风险评估和缓解策略

### 技术风险
1. **JUCE 集成复杂性**
   - 风险：C++/Swift 桥接可能遇到内存管理问题
   - 缓解：使用 RAII 和智能指针，充分测试内存泄漏

2. **实时音频性能**
   - 风险：插件处理可能导致音频断续
   - 缓解：优化缓冲区大小，实现插件旁路机制

3. **插件兼容性**
   - 风险：某些插件可能不稳定或崩溃
   - 缓解：实现插件隔离，优雅的错误处理

### 项目风险
1. **开发时间**
   - 风险：功能复杂可能导致延期
   - 缓解：分阶段开发，优先实现核心功能

2. **用户体验**
   - 风险：界面复杂可能影响易用性
   - 缓解：保持现有设计风格，渐进式功能暴露

## 测试策略

### 单元测试
- C++ 核心组件测试
- Swift 服务层测试
- 桥接层数据传递测试

### 集成测试
- 插件加载和卸载测试
- 音频处理链测试
- 实时性能测试

### 用户测试
- Ozone 11 完整工作流测试
- 批量处理压力测试
- 用户界面易用性测试

## 文档要求

### 开发文档
- API 接口文档
- 架构设计文档
- 性能优化指南

### 用户文档
- 功能使用指南
- 插件配置教程
- 故障排除手册

---

**注意**：本文档将随着开发进展持续更新，确保与实际实现保持同步。
